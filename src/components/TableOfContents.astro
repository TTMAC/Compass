---
interface Heading {
  depth: number;
  text: string;
  slug: string;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;
const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);
---

{
  tocHeadings.length > 0 && (
    <nav
      class="toc-container"
      aria-label="Table of contents"
      data-testid="table-of-contents"
    >
      {/* Mobile: collapsible */}
      <details class="lg:hidden border border-gray-200 rounded-lg p-4 mb-6">
        <summary class="font-heading text-sm font-semibold text-text-primary cursor-pointer">
          On this page
        </summary>
        <ul class="mt-3 space-y-2" role="list">
          {tocHeadings.map((heading) => (
            <li
              class={heading.depth === 3 ? "pl-4" : ""}
            >
              <a
                href={`#${heading.slug}`}
                class="block py-1 text-sm text-text-secondary hover:text-compass-green transition-colors"
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </details>

      {/* Desktop: sticky sidebar */}
      <aside class="hidden lg:block fixed-toc">
        <p class="font-heading text-xs font-semibold text-text-secondary uppercase tracking-wide mb-3">
          On this page
        </p>
        <ul class="space-y-1.5" role="list">
          {tocHeadings.map((heading) => (
            <li
              class={heading.depth === 3 ? "pl-3" : ""}
            >
              <a
                href={`#${heading.slug}`}
                class="block py-1 text-sm text-text-secondary hover:text-compass-green transition-colors toc-link"
                data-toc-link
                data-heading-id={heading.slug}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </aside>
    </nav>
  )
}

<style>
  .fixed-toc {
    position: fixed;
    top: 6rem;
    left: calc(50% + 380px);
    width: 220px;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
  }

  @media (max-width: 1280px) {
    .fixed-toc {
      display: none;
    }
  }

  details[open] summary ~ ul {
    animation: slideDown 200ms ease-in-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .toc-link.active {
    color: #1b6b4a;
    font-weight: 600;
  }
</style>

<script>
  const tocLinks = document.querySelectorAll("[data-toc-link]");

  if (tocLinks.length > 0) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            tocLinks.forEach((link) => link.classList.remove("active"));
            const activeLink = document.querySelector(
              `[data-heading-id="${entry.target.id}"]`,
            );
            activeLink?.classList.add("active");
          }
        });
      },
      {
        rootMargin: "-80px 0px -80% 0px",
      },
    );

    tocLinks.forEach((link) => {
      const id = link.getAttribute("data-heading-id");
      if (id) {
        const heading = document.getElementById(id);
        if (heading) observer.observe(heading);
      }
    });
  }
</script>
